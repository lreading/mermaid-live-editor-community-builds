name: build-latest

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/lreading/mermaid-live-editor-community-builds
  UPSTREAM_REPO: mermaid-js/mermaid-live-editor
  UPSTREAM_BRANCH: master

jobs:
  prep:
    name: Resolve upstream SHA
    runs-on: ubuntu-24.04
    outputs:
      sha: ${{ steps.meta.outputs.sha }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
      ts: ${{ steps.meta.outputs.ts }}
    steps:
      - id: meta
        shell: bash
        run: |
          set -euo pipefail

          SHA="$(git ls-remote "https://github.com/${UPSTREAM_REPO}.git" "refs/heads/${UPSTREAM_BRANCH}" | awk '{print $1}')"
          if [ -z "$SHA" ]; then
            echo "Unable to resolve upstream SHA for ${UPSTREAM_REPO}@${UPSTREAM_BRANCH}" >&2
            exit 1
          fi

          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHA:0:12}" >> "$GITHUB_OUTPUT"
          echo "ts=$(date -u +%Y%m%d%H%M%S)" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.variant }} on ${{ matrix.arch }}
    needs: prep
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        variant: [nocloud, kroki-default, renderer-default, kroki-renderer-default]
        include:
          - arch: amd64
            runner: ubuntu-24.04
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v6

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Clone upstream at resolved SHA
        shell: bash
        run: |
          set -euo pipefail

          git clone --filter=blob:none --no-checkout "https://github.com/${UPSTREAM_REPO}.git" upstream
          git -C upstream fetch --depth=1 origin "${{ needs.prep.outputs.sha }}"
          git -C upstream checkout -f FETCH_HEAD
          git -C upstream rev-parse HEAD

      - name: Build & push (single-arch)
        shell: bash
        run: |
          set -euo pipefail

          SHA="${{ needs.prep.outputs.sha }}"
          SHORT_SHA="${{ needs.prep.outputs.short_sha }}"
          TS="${{ needs.prep.outputs.ts }}"

          VARIANT="${{ matrix.variant }}"
          PLATFORM="${{ matrix.platform }}"
          ARCH="${{ matrix.arch }}"

          LABELS=(
            --label "org.opencontainers.image.title=mermaid-live-editor-community-builds"
            --label "org.opencontainers.image.source=https://github.com/${GITHUB_REPOSITORY}"
            --label "org.opencontainers.image.revision=${GITHUB_SHA}"
            --label "org.opencontainers.image.description=Community builds of Mermaid Live Editor (built from ${UPSTREAM_REPO}@${SHORT_SHA} on ${UPSTREAM_BRANCH})"
            --label "io.lreading.upstream.repo=${UPSTREAM_REPO}"
            --label "io.lreading.upstream.branch=${UPSTREAM_BRANCH}"
            --label "io.lreading.upstream.sha=${SHA}"
          )

          REF_ARCH="${IMAGE_NAME}:${VARIANT}-${TS}-${SHORT_SHA}-${ARCH}"

          BUILD_ARGS=(
            --build-arg MERMAID_ANALYTICS_URL=
            --build-arg MERMAID_DOMAIN=
            --build-arg MERMAID_IS_ENABLED_MERMAID_CHART_LINKS=
          )

          case "${VARIANT}" in
            nocloud)
              BUILD_ARGS+=(--build-arg MERMAID_RENDERER_URL= --build-arg MERMAID_KROKI_RENDERER_URL=)
              ;;
            kroki-default)
              BUILD_ARGS+=(--build-arg MERMAID_RENDERER_URL=)
              ;;
            renderer-default)
              BUILD_ARGS+=(--build-arg MERMAID_KROKI_RENDERER_URL=)
              ;;
            kroki-renderer-default)
              # Keep both renderer URLs at defaults, but still disable analytics/domain/chart-links.
              ;;
            *)
              echo "Unknown variant: ${VARIANT}" >&2
              exit 1
              ;;
          esac

          docker buildx build \
            --platform "${PLATFORM}" \
            --push \
            -t "${REF_ARCH}" \
            "${LABELS[@]}" \
            "${BUILD_ARGS[@]}" \
            --cache-from type=gha,scope="${VARIANT}-${ARCH}" \
            --cache-to type=gha,mode=max,scope="${VARIANT}-${ARCH}" \
            ./upstream

  manifest:
    name: Publish multi-arch tags
    needs: [prep, build]
    runs-on: ubuntu-24.04
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create multi-arch manifests
        shell: bash
        run: |
          set -euo pipefail

          SHORT_SHA="${{ needs.prep.outputs.short_sha }}"
          TS="${{ needs.prep.outputs.ts }}"

          variants=(nocloud kroki-default renderer-default kroki-renderer-default)

          for v in "${variants[@]}"; do
            amd="${IMAGE_NAME}:${v}-${TS}-${SHORT_SHA}-amd64"
            arm="${IMAGE_NAME}:${v}-${TS}-${SHORT_SHA}-arm64"

            # Create a manifest list (multi-arch) from the already-pushed per-arch images.
            docker buildx imagetools create \
              -t "${IMAGE_NAME}:${v}" \
              -t "${IMAGE_NAME}:${v}-${SHORT_SHA}" \
              -t "${IMAGE_NAME}:${v}-${TS}" \
              "${amd}" \
              "${arm}"
          done

