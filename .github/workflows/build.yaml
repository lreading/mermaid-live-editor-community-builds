name: build-latest

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/lreading/mermaid-live-editor-community-builds
  UPSTREAM_REPO: mermaid-js/mermaid-live-editor

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v6

      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Clone upstream
        id: upstream
        run: |
          set -euo pipefail

          git clone --filter=blob:none --no-checkout "https://github.com/${UPSTREAM_REPO}.git" upstream

          # "develop" is the default branch, but Mermaid Live Editor's
          # README calls out that releases are cut from the "master" branch
          git -C upstream fetch --depth=1 origin master
          git -C upstream checkout -f FETCH_HEAD

          SHA="$(git -C upstream rev-parse HEAD)"
          SHORT_SHA="${SHA:0:12}"
          TS="$(date -u +%Y%m%d%H%M%S)"

          echo "branch=master" >> "$GITHUB_OUTPUT"
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "ts=${TS}" >> "$GITHUB_OUTPUT"

      - name: Build & push
        run: |
          set -euo pipefail

          BRANCH="${{ steps.upstream.outputs.branch }}"
          SHA="${{ steps.upstream.outputs.sha }}"
          SHORT_SHA="${{ steps.upstream.outputs.short_sha }}"
          TS="${{ steps.upstream.outputs.ts }}"

          LABELS=(
            --label "org.opencontainers.image.title=mermaid-live-editor-community-builds"
            --label "org.opencontainers.image.source=https://github.com/${GITHUB_REPOSITORY}"
            --label "org.opencontainers.image.revision=${GITHUB_SHA}"
            --label "org.opencontainers.image.description=Community builds of Mermaid Live Editor (built from ${UPSTREAM_REPO}@${SHORT_SHA} on ${BRANCH})"
            --label "io.lreading.upstream.repo=${UPSTREAM_REPO}"
            --label "io.lreading.upstream.branch=${BRANCH}"
            --label "io.lreading.upstream.sha=${SHA}"
          )

          base_tags() {
            local variant="$1"
            echo "-t ${IMAGE_NAME}:latest-${variant} -t ${IMAGE_NAME}:${BRANCH}-${variant} -t ${IMAGE_NAME}:${TS}-${variant} -t ${IMAGE_NAME}:sha-${SHORT_SHA}-${variant}"
          }

          build_variant() {
            local variant="$1"
            shift

            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --push \
              $(base_tags "$variant") \
              "${LABELS[@]}" \
              "$@" \
              ./upstream
          }

          build_variant "nocloud" \
            --build-arg MERMAID_ANALYTICS_URL= \
            --build-arg MERMAID_DOMAIN= \
            --build-arg MERMAID_IS_ENABLED_MERMAID_CHART_LINKS= \
            --build-arg MERMAID_RENDERER_URL= \
            --build-arg MERMAID_KROKI_RENDERER_URL=

          build_variant "kroki-default" \
            --build-arg MERMAID_ANALYTICS_URL= \
            --build-arg MERMAID_DOMAIN= \
            --build-arg MERMAID_IS_ENABLED_MERMAID_CHART_LINKS= \
            --build-arg MERMAID_RENDERER_URL=

          build_variant "renderer-default" \
            --build-arg MERMAID_ANALYTICS_URL= \
            --build-arg MERMAID_DOMAIN= \
            --build-arg MERMAID_IS_ENABLED_MERMAID_CHART_LINKS= \
            --build-arg MERMAID_KROKI_RENDERER_URL=

          build_variant "kroki-renderer-default" \
            --build-arg MERMAID_ANALYTICS_URL= \
            --build-arg MERMAID_DOMAIN= \
            --build-arg MERMAID_IS_ENABLED_MERMAID_CHART_LINKS=

